steps:
    # TEST: docker-compose up
    - name: 'gcr.io/$PROJECT_ID/docker-compose'
      args: ['up', '-d']

    # TEST: curl web
    - name: 'gcr.io/cloud-builders/docker'
      entrypoint: 'curl'
      args: ['web']

    - name: 'gcr.io/cloud-builders/go'
      args: ['install', '.']
      env: ['PROJECT_ROOT=github.com/kokukuma/gcr-proxy']
      dir: 'proxy'

    - name: 'gcr.io/cloud-builders/go'
      args: ['test', 'proxy/proxy_test.go']
      env: ['PROJECT_ROOT=github.com/kokukuma/gcr-proxy']

    - name: 'gcr.io/cloud-builders/docker'
      args: ['build', '-t', 'gcr.io/$PROJECT_ID/gcrproxy', '.']

    # TEST: docker-compose down
    - name: 'gcr.io/$PROJECT_ID/docker-compose'
      args: ['down']

images:
    - 'gcr.io/$PROJECT_ID/gcrproxy'
